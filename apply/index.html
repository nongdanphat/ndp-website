<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ứng tuyển công việc - NDP</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ============================================ -->
    <!-- CẤU HÌNH - Thay đổi URL bên dưới -->
    <!-- ============================================ -->
    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxrSvUSrNM1S9Wiw4_uX0ptjIoMBmm8onBzIkiwL2_K3l4tz4N_JKzBf1tlci9wYKxA/exec";
    </script>

    <style>
      /* Custom checkbox - đảm bảo checkmark hiển thị */
      #checkbox-custom {
        position: relative;
      }

      #checkbox-checkmark {
        position: absolute;
        z-index: 1;
      }

      /* Custom dropdown panel styling */
      #experience-panel {
        max-height: 200px;
        overflow-y: auto;
      }

      /* Scrollbar styling cho dropdown panel */
      #experience-panel::-webkit-scrollbar {
        width: 6px;
      }

      #experience-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #experience-panel::-webkit-scrollbar-thumb {
        background: #ab7e31;
        border-radius: 10px;
      }

      #experience-panel::-webkit-scrollbar-thumb:hover {
        background: #8b6a28;
      }
    </style>
  </head>
  <body class="bg-white text-gray-900">
    <!-- Header placeholder - will be loaded dynamically -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <main class="min-h-screen py-12">
      <div class="container mx-auto px-4 max-w-6xl">
        <div class="grid lg:grid-cols-2 gap-8 items-start">
          <!-- Left: Illustration -->
          <div class="hidden lg:block">
            <div
              class="bg-gradient-to-br from-[#FADC7C] to-white rounded-xl p-8 shadow-md sticky top-24"
            >
              <div class="aspect-square rounded-xl overflow-hidden">
                <img
                  src="../assets/images/ung-tuyen.jpg"
                  alt="Ứng tuyển công việc"
                  class="w-full h-full object-cover rounded-xl"
                />
              </div>
            </div>
          </div>

          <!-- Right: Form -->
          <div>
            <div
              class="bg-white border border-gray-200 rounded-xl p-8 shadow-md"
            >
              <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6">
                Ứng tuyển công việc
              </h1>

              <form id="application-form" class="space-y-6">
                <!-- Họ và tên -->
                <div>
                  <label
                    for="fullName"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Họ và tên <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="fullName"
                    name="fullName"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition"
                    placeholder="Nhập họ và tên của bạn"
                  />
                </div>

                <!-- Email -->
                <div>
                  <label
                    for="email"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Email <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition"
                    placeholder="example@email.com"
                  />
                </div>

                <!-- Số điện thoại -->
                <div>
                  <label
                    for="phone"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Số điện thoại <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    required
                    inputmode="numeric"
                    pattern="[0-9]*"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition"
                    placeholder="0123456789"
                  />
                </div>

                <!-- Nơi mong muốn làm việc -->
                <div>
                  <label
                    for="location"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Nơi mong muốn làm việc <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="location"
                    name="location"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition"
                    placeholder="Ví dụ: TP. Hồ Chí Minh, Đồng bằng sông Cửu Long"
                  />
                </div>

                <!-- Công việc / Vị trí -->
                <div>
                  <label
                    for="position"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Công việc / Vị trí <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="position"
                    name="position"
                    required
                    readonly
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition"
                    placeholder="Vị trí công việc"
                  />
                </div>

                <!-- Kinh nghiệm -->
                <div>
                  <label
                    for="experience"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Kinh nghiệm <span class="text-red-500">*</span>
                  </label>
                  <div class="relative">
                    <!-- Hidden select for form submission -->
                    <select
                      id="experience"
                      name="experience"
                      required
                      class="hidden"
                    >
                      <option value="">-- Chọn kinh nghiệm --</option>
                      <option value="Đã có kinh nghiệm">
                        Đã có kinh nghiệm
                      </option>
                      <option value="Mới ra trường">Mới ra trường</option>
                      <option value="Thực tập">Thực tập</option>
                    </select>

                    <!-- Custom Dropdown -->
                    <div id="experience-dropdown" class="relative w-full">
                      <button
                        type="button"
                        id="experience-button"
                        class="w-full px-4 py-3.5 text-left border border-gray-300 rounded-xl bg-white hover:border-[#AB7E31] focus:ring-2 focus:ring-[#AB7E31] focus:border-transparent outline-none transition flex items-center justify-between"
                      >
                        <span id="experience-selected" class="text-gray-700">
                          -- Chọn kinh nghiệm --
                        </span>
                        <svg
                          id="experience-arrow"
                          class="w-5 h-5 text-[#AB7E31] transition-transform"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 9l-7 7-7-7"
                          ></path>
                        </svg>
                      </button>

                      <!-- Dropdown Panel -->
                      <div
                        id="experience-panel"
                        class="hidden absolute z-50 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden"
                      >
                        <div
                          class="experience-option px-5 py-3.5 text-gray-700 hover:bg-[#FADC7C] cursor-pointer transition-colors"
                          data-value=""
                        >
                          -- Chọn kinh nghiệm --
                        </div>
                        <div
                          class="experience-option px-5 py-3.5 text-gray-700 hover:bg-[#FADC7C] cursor-pointer transition-colors"
                          data-value="Đã có kinh nghiệm"
                        >
                          Đã có kinh nghiệm
                        </div>
                        <div
                          class="experience-option px-5 py-3.5 text-gray-700 hover:bg-[#FADC7C] cursor-pointer transition-colors"
                          data-value="Mới ra trường"
                        >
                          Mới ra trường
                        </div>
                        <div
                          class="experience-option px-5 py-3.5 text-gray-700 hover:bg-[#FADC7C] cursor-pointer transition-colors"
                          data-value="Thực tập"
                        >
                          Thực tập
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tải CV -->
                <div>
                  <label
                    for="cvFile"
                    class="block text-sm font-medium text-gray-700 mb-2"
                  >
                    Tải CV
                    <span class="text-gray-500 text-xs">(Không bắt buộc)</span>
                  </label>
                  <div class="flex items-center gap-4">
                    <input
                      type="file"
                      id="cvFile"
                      name="cvFile"
                      accept=".pdf,.doc,.docx,.png,.jpg,.zip"
                      class="hidden"
                    />
                    <button
                      type="button"
                      id="cvFileButton"
                      class="px-6 py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-600 hover:border-[#AB7E31] hover:text-[#AB7E31] transition cursor-pointer"
                    >
                      Chọn file CV
                    </button>
                    <span id="cvFileName" class="text-sm text-gray-500"></span>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">
                    Chấp nhận: PDF, DOC, DOCX, PNG, JPG, ZIP. Dung lượng tối đa:
                    5MB
                  </p>
                </div>

                <!-- Checkbox xác nhận -->
                <div class="flex items-start">
                  <label for="policy" class="flex items-start cursor-pointer">
                    <div class="relative mt-0.5">
                      <input
                        type="checkbox"
                        id="policy"
                        name="policy"
                        checked
                        required
                        class="sr-only"
                      />
                      <div
                        id="checkbox-custom"
                        class="w-5 h-5 border-2 border-gray-300 rounded bg-white transition-all duration-200 flex items-center justify-center hover:border-[#AB7E31] cursor-pointer relative"
                      >
                        <svg
                          id="checkbox-checkmark"
                          class="w-3.5 h-3.5 text-white absolute transition-opacity duration-200"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          style="opacity: 0; display: none"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="3.5"
                            d="M5 13l4 4L19 7"
                          ></path>
                        </svg>
                      </div>
                    </div>
                    <span class="ml-2 text-sm text-gray-700">
                      Tôi xác nhận đã đọc và đồng ý với chính sách bảo mật và
                      điều khoản sử dụng
                      <span class="text-red-500">*</span>
                    </span>
                  </label>
                </div>

                <!-- Nút Gửi -->
                <div>
                  <button
                    type="submit"
                    id="submitButton"
                    class="w-full bg-gradient-to-r from-[#AB7E31] to-[#BE8F2B] text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Gửi đơn ứng tuyển
                  </button>
                </div>

                <div id="message" class="hidden mt-4 p-4 rounded-xl"></div>
              </form>

              <!-- Success Message (ẩn ban đầu) -->
              <div id="success-message" class="hidden">
                <div class="text-center py-12">
                  <div class="mb-6">
                    <svg
                      class="w-20 h-20 mx-auto text-green-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                  </div>
                  <h2 class="text-3xl font-bold text-gray-900 mb-4">
                    Đơn ứng tuyển đã được gửi thành công!
                  </h2>
                  <p class="text-lg text-gray-600 mb-8">
                    Chúng tôi đã nhận được đơn ứng tuyển của bạn. Chúng tôi sẽ
                    liên hệ với bạn sớm nhất có thể.
                  </p>
                  <a
                    id="back-to-job-button"
                    href="#"
                    class="inline-block bg-gradient-to-r from-[#AB7E31] to-[#BE8F2B] text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition"
                  >
                    Trở về trang chi tiết việc làm
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer placeholder - will be loaded dynamically -->
    <div id="footer-placeholder"></div>

    <!-- Load header and footer -->
    <script src="../load-header-footer.js"></script>

    <!-- JavaScript -->
    <script>
      // Load position from sessionStorage
      const positionInput = document.getElementById("position");
      const savedPosition = sessionStorage.getItem("jobPosition");
      if (savedPosition) {
        positionInput.value = savedPosition;
      }

      // Custom Dropdown cho Kinh nghiệm
      const experienceSelect = document.getElementById("experience");
      const experienceButton = document.getElementById("experience-button");
      const experienceSelected = document.getElementById("experience-selected");
      const experiencePanel = document.getElementById("experience-panel");
      const experienceArrow = document.getElementById("experience-arrow");
      const experienceOptions = document.querySelectorAll(".experience-option");

      // Toggle dropdown
      experienceButton.addEventListener("click", function (e) {
        e.stopPropagation();
        const isOpen = !experiencePanel.classList.contains("hidden");
        if (isOpen) {
          experiencePanel.classList.add("hidden");
          experienceArrow.classList.remove("rotate-180");
        } else {
          experiencePanel.classList.remove("hidden");
          experienceArrow.classList.add("rotate-180");
        }
      });

      // Select option
      experienceOptions.forEach((option) => {
        option.addEventListener("click", function () {
          const value = this.getAttribute("data-value");
          const text = this.textContent.trim();

          // Update selected text
          experienceSelected.textContent = text;

          // Update hidden select
          experienceSelect.value = value;

          // Update selected option style
          experienceOptions.forEach((opt) => {
            if (opt === this) {
              opt.classList.add("bg-[#AB7E31]", "text-white");
              opt.classList.remove("text-gray-700", "hover:bg-[#FADC7C]");
            } else {
              opt.classList.remove("bg-[#AB7E31]", "text-white");
              opt.classList.add("text-gray-700", "hover:bg-[#FADC7C]");
            }
          });

          // Close dropdown
          experiencePanel.classList.add("hidden");
          experienceArrow.classList.remove("rotate-180");

          // Trigger change event for validation
          experienceSelect.dispatchEvent(new Event("change"));
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        if (
          !experienceButton.contains(e.target) &&
          !experiencePanel.contains(e.target)
        ) {
          experiencePanel.classList.add("hidden");
          experienceArrow.classList.remove("rotate-180");
        }
      });

      // Initialize selected option style if có giá trị mặc định
      if (experienceSelect.value) {
        experienceOptions.forEach((opt) => {
          if (opt.getAttribute("data-value") === experienceSelect.value) {
            opt.classList.add("bg-[#AB7E31]", "text-white");
            opt.classList.remove("text-gray-700", "hover:bg-[#FADC7C]");
            experienceSelected.textContent = opt.textContent.trim();
          }
        });
      }

      // Custom checkbox handling
      const policyCheckbox = document.getElementById("policy");
      const checkboxCustom = document.getElementById("checkbox-custom");
      const checkboxCheckmark = document.getElementById("checkbox-checkmark");

      function updateCheckbox() {
        if (policyCheckbox.checked) {
          checkboxCustom.style.backgroundColor = "#AB7E31";
          checkboxCustom.style.borderColor = "#AB7E31";
          checkboxCheckmark.style.opacity = "1";
          checkboxCheckmark.style.display = "block";
        } else {
          checkboxCustom.style.backgroundColor = "white";
          checkboxCustom.style.borderColor = "#D1D5DB";
          checkboxCheckmark.style.opacity = "0";
          checkboxCheckmark.style.display = "none";
        }
      }

      // Initialize checkbox
      updateCheckbox();

      // Update on change
      policyCheckbox.addEventListener("change", updateCheckbox);

      // Also update when clicking on the custom checkbox div
      checkboxCustom.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        policyCheckbox.checked = !policyCheckbox.checked;
        updateCheckbox();
      });

      // File upload handling
      const cvFileInput = document.getElementById("cvFile");
      const cvFileButton = document.getElementById("cvFileButton");
      const cvFileName = document.getElementById("cvFileName");
      let cvBase64 = "";
      let cvFileNameValue = "";
      let cvMimeType = "";

      const allowedTypes = [
        "application/pdf",
        "application/msword",
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "image/png",
        "image/jpeg",
        "application/zip",
      ];
      const allowedExtensions = [
        ".pdf",
        ".doc",
        ".docx",
        ".png",
        ".jpg",
        ".zip",
      ];
      const maxSize = 5 * 1024 * 1024; // 5MB

      cvFileButton.addEventListener("click", () => {
        cvFileInput.click();
      });

      cvFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Check file extension
        const fileName = file.name.toLowerCase();
        const isValidExtension = allowedExtensions.some((ext) =>
          fileName.endsWith(ext)
        );

        if (!isValidExtension) {
          showMessage(
            "Định dạng file không được hỗ trợ. Vui lòng chọn file PDF, DOC, DOCX, PNG, JPG hoặc ZIP.",
            "error"
          );
          cvFileInput.value = "";
          cvFileName.textContent = "";
          return;
        }

        // Check file size
        if (file.size > maxSize) {
          showMessage("File quá lớn. Dung lượng tối đa là 5MB.", "error");
          cvFileInput.value = "";
          cvFileName.textContent = "";
          return;
        }

        // Check MIME type
        if (!allowedTypes.includes(file.type)) {
          showMessage(
            "Loại file không được hỗ trợ. Vui lòng chọn file PDF, DOC, DOCX, PNG, JPG hoặc ZIP.",
            "error"
          );
          cvFileInput.value = "";
          cvFileName.textContent = "";
          return;
        }

        // Convert to Base64
        const reader = new FileReader();
        reader.onload = (event) => {
          const base64String = event.target.result.split(",")[1];
          cvBase64 = base64String;
          cvFileNameValue = file.name;
          cvMimeType = file.type;
          cvFileName.textContent = file.name;
        };
        reader.onerror = () => {
          showMessage("Lỗi khi đọc file. Vui lòng thử lại.", "error");
          cvFileInput.value = "";
          cvFileName.textContent = "";
        };
        reader.readAsDataURL(file);
      });

      // Lưu URL trang chi tiết việc làm vào sessionStorage khi trang load
      // Kiểm tra xem có referrer từ trang chi tiết việc làm không
      if (document.referrer && document.referrer.includes("tuyen-dung")) {
        sessionStorage.setItem("jobDetailUrl", document.referrer);
      }
      // Hoặc nếu có trong URL params
      const urlParams = new URLSearchParams(window.location.search);
      const jobUrl = urlParams.get("jobUrl");
      if (jobUrl) {
        sessionStorage.setItem("jobDetailUrl", jobUrl);
      }

      // Xử lý input số điện thoại - chỉ nhận số và giữ số 0 ở đầu
      const phoneInput = document.getElementById("phone");
      phoneInput.addEventListener("input", function (e) {
        // Chỉ cho phép nhập số
        let value = e.target.value.replace(/\D/g, "");

        // Đảm bảo số 0 ở đầu nếu bắt đầu bằng số khác 0
        if (value.length > 0 && !value.startsWith("0")) {
          // Nếu không bắt đầu bằng 0 và có số, giữ nguyên
          // Nhưng nếu người dùng xóa hết và nhập lại, thêm 0
        }

        // Giới hạn tối đa 11 số (số điện thoại Việt Nam)
        if (value.length > 11) {
          value = value.substring(0, 11);
        }

        e.target.value = value;
      });

      // Xử lý khi blur - đảm bảo có số 0 ở đầu nếu có số
      phoneInput.addEventListener("blur", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 0 && !value.startsWith("0")) {
          // Không tự động thêm 0 vì có thể người dùng muốn nhập số quốc tế
          // Nhưng format để hiển thị đẹp
        }
      });

      // Form submission
      const form = document.getElementById("application-form");
      const submitButton = document.getElementById("submitButton");
      const messageDiv = document.getElementById("message");
      const successMessage = document.getElementById("success-message");
      const backToJobButton = document.getElementById("back-to-job-button");

      // Thiết lập nút quay lại
      const jobDetailUrl = sessionStorage.getItem("jobDetailUrl");
      if (jobDetailUrl) {
        backToJobButton.href = jobDetailUrl;
      } else {
        // Nếu không có URL, quay về trang danh sách việc làm
        backToJobButton.href = "../join-us/index.html";
        backToJobButton.textContent = "Trở về danh sách việc làm";
      }

      function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `mt-4 p-4 rounded-xl ${
          type === "error"
            ? "bg-red-50 text-red-700 border border-red-200"
            : "bg-green-50 text-green-700 border border-green-200"
        }`;
        messageDiv.classList.remove("hidden");
        setTimeout(() => {
          messageDiv.classList.add("hidden");
        }, 5000);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        submitButton.disabled = true;
        submitButton.textContent = "Đang gửi...";

        // Lấy số điện thoại và đảm bảo format đúng (giữ số 0 ở đầu)
        let phoneValue = document
          .getElementById("phone")
          .value.replace(/\D/g, "");

        // Giữ nguyên giá trị (Google Apps Script sẽ format cell là text)
        phoneValue = phoneValue || "";

        const formData = {
          fullName: document.getElementById("fullName").value,
          email: document.getElementById("email").value,
          phone: phoneValue, // Sử dụng giá trị đã format
          location: document.getElementById("location").value,
          position: document.getElementById("position").value,
          experience: document.getElementById("experience").value,
          base64: cvBase64 || "",
          fileName: cvFileNameValue || "",
          mimeType: cvMimeType || "",
        };

        // Sử dụng SCRIPT_URL đã khai báo ở đầu file
        const scriptUrl = SCRIPT_URL;

        // Kiểm tra kích thước dữ liệu (Google Apps Script có giới hạn ~50MB)
        const requestBody = JSON.stringify(formData);
        const requestSize = new Blob([requestBody]).size;
        const maxRequestSize = 50 * 1024 * 1024; // 50MB

        if (requestSize > maxRequestSize) {
          showMessage(
            "Dữ liệu quá lớn. Vui lòng chọn file CV nhỏ hơn (tối đa 5MB).",
            "error"
          );
          submitButton.disabled = false;
          submitButton.textContent = "Gửi đơn ứng tuyển";
          return;
        }

        // Sử dụng form submission với iframe ẩn để tránh CORS và redirect
        // LƯU Ý: Sẽ có lỗi 403 trong console do Google Apps Script chặn iframe (X-Frame-Options)
        // Nhưng lỗi này KHÔNG ảnh hưởng - dữ liệu vẫn được gửi thành công vào Google Sheet
        try {
          // Tạo iframe ẩn để submit form vào đó (tránh redirect trang)
          const iframe = document.createElement("iframe");
          iframe.name = "hidden-submit-iframe-" + Date.now();
          iframe.style.position = "fixed";
          iframe.style.left = "-9999px";
          iframe.style.top = "-9999px";
          iframe.style.width = "1px";
          iframe.style.height = "1px";
          iframe.style.border = "none";
          iframe.style.opacity = "0";
          iframe.style.pointerEvents = "none";

          document.body.appendChild(iframe);

          // Tạo form ẩn
          const hiddenForm = document.createElement("form");
          hiddenForm.method = "POST";
          hiddenForm.action = scriptUrl;
          hiddenForm.target = iframe.name;
          hiddenForm.style.display = "none";

          // Thêm dữ liệu vào form
          Object.keys(formData).forEach((key) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = formData[key];
            hiddenForm.appendChild(input);
          });

          document.body.appendChild(hiddenForm);

          let isCompleted = false;

          // Hàm xử lý thành công
          const handleSuccess = () => {
            if (isCompleted) return;
            isCompleted = true;

            // Ẩn form
            form.style.display = "none";

            // Hiển thị success message
            successMessage.classList.remove("hidden");

            // Reset form data
            form.reset();
            cvFileInput.value = "";
            cvFileName.textContent = "";
            cvBase64 = "";
            cvFileNameValue = "";
            cvMimeType = "";
            sessionStorage.removeItem("jobPosition");

            // Cleanup sau 2 giây
            setTimeout(() => {
              if (hiddenForm.parentNode) {
                document.body.removeChild(hiddenForm);
              }
              if (iframe.parentNode) {
                document.body.removeChild(iframe);
              }
            }, 2000);

            submitButton.disabled = false;
            submitButton.textContent = "Gửi đơn ứng tuyển";
          };

          // Timeout fallback (submit form ngay, không đợi iframe load)
          // Google Apps Script sẽ chặn iframe (403), nhưng dữ liệu đã được gửi thành công
          const timeoutId = setTimeout(() => {
            handleSuccess();
          }, 2000); // Giảm xuống 2 giây vì không cần đợi iframe load

          // Submit form ngay lập tức
          // Dữ liệu sẽ được gửi đến Google Apps Script trước khi iframe bị chặn
          hiddenForm.submit();

          // Xử lý khi iframe load xong (nếu có thể, nhưng thường sẽ bị chặn 403)
          iframe.onload = function () {
            clearTimeout(timeoutId);
            handleSuccess();
          };
        } catch (error) {
          console.error("Form submission error:", error);
          showMessage(
            "Có lỗi xảy ra khi gửi đơn ứng tuyển. Vui lòng thử lại sau.",
            "error"
          );
          submitButton.disabled = false;
          submitButton.textContent = "Gửi đơn ứng tuyển";
        }
      });
    </script>
  </body>
</html>
